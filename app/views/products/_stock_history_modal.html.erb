<dialog id="history_modal_<%= product.id %>" class="modal">
  <div class="modal-box max-w-4xl">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
    </form>
    <h3 class="font-bold text-lg mb-4">Historia magazynowa - <%= product.name %></h3>
    <% stock_movements = product.product_stock_movements.order(created_at: :desc) %>
    <% if stock_movements.any? %>
      <div class="overflow-x-auto">
        <table class="table table-zebra table-sm">
          <thead>
            <tr>
              <th>Data</th>
              <th>Typ operacji</th>
              <th>Zamówienie</th>
              <th>Stan przed</th>
              <th>Zmiana</th>
              <th>Stan po</th>
            </tr>
          </thead>
          <tbody>
            <% stock_movements.each do |movement| %>
              <tr>
                <td><%= movement.created_at.strftime("%d.%m.%Y %H:%M") %></td>
                <td>
                  <% if movement.restock? %>
                    <span class="badge badge-success"><%= movement.movement_type_name %></span>
                  <% elsif movement.sale? %>
                    <span class="badge badge-info"><%= movement.movement_type_name %></span>
                  <% end %>
                </td>
                <td>
                  <% if movement.order_item %>
                    <%= link_to "##{movement.order_item.order.order_number}", order_path(movement.order_item.order), class: "link link-primary" %>
                  <% else %>
                    <span class="text-gray-400">-</span>
                  <% end %>
                </td>
                <td><%= movement.quantity_before %></td>
                <td>
                  <% if movement.increase? %>
                    <span class="text-success font-semibold">+<%= movement.quantity_change %></span>
                  <% else %>
                    <span class="text-error font-semibold"><%= movement.quantity_change %></span>
                  <% end %>
                </td>
                <td><%= movement.quantity_after %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="alert alert-info">
        <%= lucide_icon('info', class: 'w-4 h-4') %>
        <span>Brak historii magazynowej dla tego produktu</span>
      </div>
    <% end %>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
