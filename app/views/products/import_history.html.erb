<!-- filepath: /home/matis/code/livecart/app/views/products/import_history.html.erb -->
<div class="container mx-auto px-4 py-6 max-w-7xl">
  <div class="mb-6">
    <h1 class="text-2xl font-bold">Historia importów</h1>
    <p class="text-base-content/70 mt-1">Przegląd wszystkich importów produktów</p>
  </div>
  <div class="bg-base-100 rounded-lg shadow-sm">
    <table class="table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Nazwa</th>
          <th>Status</th>
          <th>Strategia duplikatów</th>
          <th>Liczba produktów</th>
          <th>Zaimportowano</th>
          <th>Pominięto</th>
          <th>Błędy</th>
        </tr>
      </thead>
      <tbody>
        <% @product_imports.each do |import| %>
          <tr>
            <td>
              <%= l(import.created_at, format: :short) %>
            </td>
            <td>
              <strong><%= import.import_name %></strong>
            </td>
            <td>
              <div class="badge 
                  <%= case import.status
                      when 'completed' then 'badge-success'
                      when 'failed' then 'badge-error'
                      when 'processing' then 'badge-info'
                      else 'badge-warning'
                      end %>">
                <%= ProductImport::STATUS_NAMES[import.status.to_sym] %>
              </div>
            </td>
            <td>
              <%= ProductImport::DUPLICATE_STRATEGIES_NAMES[import.duplicate_strategy.to_sym] %>
            </td>
            <td>
              <%= import.total_rows %>
            </td>
            <td class="text-success font-semibold">
              <%= import.success_count %>
            </td>
            <td>
              <%= import.skipped_count %>
            </td>
            <td>
              <% if import.error_count > 0 %>
                <button type="button" 
                        class="btn btn-ghost btn-xs text-error"
                        onclick="document.getElementById('error_modal_<%= import.id %>').showModal()">
                  <%= import.error_count %>
                </button>
                <dialog id="error_modal_<%= import.id %>" class="modal">
                  <div class="modal-box">
                    <h3 class="font-bold text-lg">Błędy importu</h3>
                    <div class="py-4">
                      <ul class="list-disc list-inside space-y-1">
                        <% import.formatted_errors.each do |error| %>
                          <li class="text-sm"><%= error %></li>
                        <% end %>
                      </ul>
                    </div>
                    <div class="modal-action">
                      <form method="dialog">
                        <button class="btn">Zamknij</button>
                      </form>
                    </div>
                  </div>
                </dialog>
              <% else %>
                <span class="text-base-content/50">0</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <div class="flex items-center justify-end gap-4 px-4 py-3 border-t border-base-200">
      <div class="flex items-center gap-1">
        <% if @pagy.page > 1 %>
          <%= link_to import_history_products_path(request.params.merge(page: @pagy.page - 1)), class: "p-1 rounded hover:bg-base-200 transition-colors" do %>
            <%= lucide_icon('chevron-left', class: 'w-4 h-4') %>
          <% end %>
        <% else %>
          <span class="p-1 opacity-30"><%= lucide_icon('chevron-left', class: 'w-4 h-4') %></span>
        <% end %>
        <span class="px-2 tabular-nums"><%= @pagy.page %> / <%= @pagy.pages %></span>
        <% if @pagy.page < @pagy.pages %>
          <%= link_to import_history_products_path(request.params.merge(page: @pagy.page + 1)), class: "p-1 rounded hover:bg-base-200 transition-colors" do %>
            <%= lucide_icon('chevron-right', class: 'w-4 h-4') %>
          <% end %>
        <% else %>
          <span class="p-1 opacity-30"><%= lucide_icon('chevron-right', class: 'w-4 h-4') %></span>
        <% end %>
      </div>
    </div>
  </div>
</div>