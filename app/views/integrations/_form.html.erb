<%= form_with model: integration, class: "space-y-6" do |f| %>
  <% if integration.errors.any? %>
    <div class="alert alert-error">
      <%= lucide_icon("alert-circle", class: "w-5 h-5") %>
      <div>
        <h3 class="font-bold">Wystąpiły błędy:</h3>
        <ul class="list-disc list-inside text-sm mt-1">
          <% integration.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>
  <div class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body">
      <h2 class="card-title text-lg mb-4">Podstawowe informacje</h2>
      <!-- Provider (hidden if already set, shown as readonly if from tile) -->
      <% if integration.provider.present? %>
        <%= f.hidden_field :provider %>
        <div class="form-control">
          <%= f.label :provider, "Platforma", class: "label" %>
          <div class="input input-bordered w-full bg-base-200 cursor-not-allowed flex items-center">
            <%= integration.provider_name %>
          </div>
          <label class="label">
            <span class="label-text-alt text-base-content/60">Wybrana platforma</span>
          </label>
        </div>
      <% else %>
        <div class="form-control">
          <%= f.label :provider, "Platforma *", class: "label" %>
          <%= f.select :provider, 
              Integration.provider_options, 
              { include_blank: "Wybierz platformę" },
              { 
                class: "select select-bordered w-full",
                required: true
              } %>
        </div>
      <% end %>
      <!-- Provider Account Name -->
      <div class="form-control">
        <%= f.label :provider_account_name, "Nazwa konta (opcjonalnie)", class: "label" %>
        <%= f.text_field :provider_account_name, 
            class: "input input-bordered w-full"
            %>
      </div>
      <!-- Status -->
      <div class="form-control">
        <%= f.label :status, "Status", class: "label" %>
        <%= f.select :status, 
            [
              ["Aktywna", "active"],
              ["Nieaktywna", "inactive"]
            ],
            {},
            { class: "select select-bordered w-full" } %>
      </div>
    </div>
  </div>
  <!-- Credentials Card -->
  <div class="card bg-base-100 border border-base-300 shadow-sm">
    <div class="card-body">
      <h2 class="card-title text-lg mb-4">Dane uwierzytelniające</h2>
      <div class="alert alert-info mb-4">
        <%= lucide_icon("info", class: "w-5 h-5") %>
        <span class="text-sm">
          <%= render "integrations/credentials_help", integration: integration %>
        </span>
      </div>
      <!-- API Key -->
      <div class="form-control">
        <%= f.label :api_key, "API Key *", class: "label" %>
        <%= f.password_field :api_key, 
            class: "input input-bordered w-full font-mono text-sm",
            placeholder: integration.api_key.present? ? "••••••••••••••••" : "Wklej swój API key",
            required: integration.api_key.blank?,
            autocomplete: "off" %>
        <% if integration.api_key.present? %>
          <label class="label mt-2">
            <span class="label-text-alt text-success flex items-center gap-1">
              <%= lucide_icon("check-circle", class: "w-4 h-4") %>
              API Key jest już zapisany – pozostaw puste, aby nie zmieniać
            </span>
          </label>
        <% end %>
      </div>
      <!-- API Secret (only for providers that require it) -->
      <% if integration.requires_api_secret? %>
        <div class="form-control">
          <%= f.label :api_secret, "API Secret *", class: "label" %>
          <%= f.password_field :api_secret, 
              class: "input input-bordered w-full font-mono text-sm",
              placeholder: "Wklej swój API secret",
              required: true %>
          <label class="label">
            <span class="label-text-alt text-base-content/60">Wymagany dla <%= integration.provider_name %></span>
          </label>
        </div>
      <% end %>
    </div>
  </div>
  <!-- Provider-specific configuration (add a partial in views/integrations/provider_settings/_<provider>.html.erb) -->
  <% if integration.provider.present? && lookup_context.exists?("provider_settings/#{integration.provider}", ["integrations"], true) %>
    <%= render "integrations/provider_settings/#{integration.provider}", integration: integration %>
  <% end %>
  <!-- Actions -->
  <div class="flex gap-3">
    <%= f.submit integration.persisted? ? "Zaktualizuj integrację" : "Dodaj integrację", 
        class: "btn btn-primary flex-1" %>
    <%= link_to "Anuluj", integrations_path, class: "btn btn-ghost" %>
  </div>
<% end %>
